<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Artifact Colors Test</title>
</head>

<body>
    <input type="file" id="fileInput" accept="image/png">
    <canvas id="original" style="image-rendering: pixelated;"></canvas>
    <canvas id="bw" style="image-rendering: pixelated;"></canvas>
    <canvas id="artifact" style="image-rendering: pixelated; display: none;"></canvas>
    <canvas id="blur" style="image-rendering: pixelated;"></canvas>

    <script>
        let width;
        let height;

        document.getElementById("fileInput").addEventListener("change", handleFile);

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = () => {
                // Draw image to original canvas
                const originalCanvas = document.getElementById("original");
                width = img.width;
                height = img.height;
                originalCanvas.width = width;
                originalCanvas.height = height;
                const originalCtx = originalCanvas.getContext("2d");
                originalCtx.drawImage(img, 0, 0, width, height);

                const imgData = originalCtx.getImageData(0, 0, width, height);
                const monoBuffer = [];

                // Convert to monochrome buffer (threshold grayscale)
                for (let y = 0; y < height; y++) {
                    const row = monoBuffer[y] = [];
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        const r = imgData.data[idx];
                        const g = imgData.data[idx + 1];
                        const b = imgData.data[idx + 2];
                        const gray = (r + g + b) / 3;
                        const max = Math.max(r, g, b);
                        row[x] = (gray > 127 || max > 200) ? 1 : 0; // threshold
                    }
                }
                renderBw(monoBuffer);
                renderArtifactColors(monoBuffer);
            };
            img.src = URL.createObjectURL(file);
        }

        function renderBw(monoBuffer) {
            const canvas = document.getElementById("bw");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            const imgData = ctx.createImageData(width, height);
            const data = imgData.data;

            for (let y = 0; y < height; y++) {
                const row = monoBuffer[y];
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    data[idx] = row[x] * 255;
                    data[idx + 1] = row[x] * 255;
                    data[idx + 2] = row[x] * 255;
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imgData, 0, 0);
        }

        function renderArtifactColors(monoBuffer) {
            const canvas = document.getElementById("artifact");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            const imgData = ctx.createImageData(width, height);
            const data = imgData.data;

            for (let y = 0; y < height; y++) {
                const row = monoBuffer[y];
                for (let x = 0; x < width; x++) {
                    let color = [127, 127, 127];
                    let chromaConfidence = 0;
                    if (x >= 2 && x + 1 < width && row[x - 2] == row[x + 1]) chromaConfidence++;
                    if (x >= 1 && x + 2 < width && row[x - 1] == row[x + 2]) chromaConfidence++;
                    if ((x >= 3 && row[x - 3] == row[x]) ||  (x + 3 < width && row[x + 3] == row[x])) chromaConfidence += 2;
                    //if (x + 3 < width && row[x + 3] == row[x]) chromaConfidence++;
                    chromaConfidence *= .25;
                    //chromaConfidence *= chromaConfidence;

                    
                    if (chromaConfidence > 0) {
                        const phase = x % 3;

                        color[phase] = row[x] * 255;

                        const phase2 = (phase + 1) % 3;
                        const l2 = x - 2;
                        const r2 = x + 1;
                        if (l2 >= 0 && r2 < width) {
                            if (row[l2] && row[r2]) color[phase2] = 255;
                            if (!row[l2] && !row[r2]) color[phase2] = 0;
                        }

                        const phase3 = (phase + 2) % 3;
                        const l3 = x - 1;
                        const r3 = x + 2;
                        if (l3 >= 0 && r3 < width) {
                            if (row[l3] && row[r3]) color[phase3] = 255;
                            if (!row[l3] && !row[r3]) color[phase3] = 0;
                        }
                    }
                    const brightness = (1 - chromaConfidence) * (row[x] * 255);
                    color = [brightness + color[0] * chromaConfidence, brightness + color[1] * chromaConfidence, brightness + color[2] * chromaConfidence];

                    const idx = (y * width + x) * 4;
                    if (y % 2) {
                        data[idx] = (color[1] + color[2]) * .5;
                        data[idx + 1] = (color[0] + color[2]) * .5;
                        data[idx + 2] = (color[0] + color[1]) * .5;
                    } else {
                        data[idx] = color[0];
                        data[idx + 1] = color[1];
                        data[idx + 2] = color[2];
                    }
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imgData, 0, 0);
            renderBlur(data);
        }

        function renderBlur(data1) {
            const canvas = document.getElementById("blur");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            const imgData = ctx.createImageData(width, height);
            const data = imgData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    const w1 = (y % 2) ? 1 : 1;
                    const w2 = (y % 2) ? 1 : 1;
                    let r = data1[idx] * w1;
                    let g = data1[idx + 1] * w1;
                    let b = data1[idx + 2] * w1;
                    let t = 1 * w1;

                    if (y > 0) {
                        const idx2 = ((y - 1) * width + x) * 4;
                        r += data1[idx2] * w2 * .5;
                        g += data1[idx2 + 1] * w2 * .5;
                        b += data1[idx2 + 2] * w2 * .5;
                        t += .5 * w2;
                    }
                    if (y - 1 < height) {
                        const idx3 = ((y + 1) * width + x) * 4;
                        r += data1[idx3] * w2 * .5;
                        g += data1[idx3 + 1] * w2 * .5;
                        b += data1[idx3 + 2] * w2 * .5;
                        t += .5 * w2;
                    }
                    
                    r = r / t;
                    g = g / t;
                    b = b / t;
                    data[idx] = r;
                    data[idx + 1] = g;
                    data[idx + 2] = b;
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imgData, 0, 0);
        }
    </script>
</body>

</html>